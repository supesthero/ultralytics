# downloads.py

This file documents the purpose of `downloads.py`.


# 代码解释

`downloads.py` 文件的主要功能是提供一系列工具函数，用于处理文件的下载、解压缩和删除操作。这些函数支持从 URL 下载文件、检查磁盘空间、处理 Google Drive 链接以及并发下载等。以下是文件中主要功能的分解：

1. **`is_url` 函数**：
   - 检查给定字符串是否为有效的 URL，并可选地检查该 URL 是否在线存在。

2. **`delete_dsstore` 函数**：
   - 删除指定目录下的所有 `.DS_Store` 文件（macOS 系统生成的隐藏文件）。

3. **`zip_directory` 函数**：
   - 将一个目录压缩成 ZIP 文件，排除指定的文件类型（如 `.DS_Store`），并显示进度条。

4. **`unzip_file` 函数**：
   - 解压缩 ZIP 文件到指定路径，排除指定的文件类型，并显示进度条。
   - 如果 ZIP 文件包含多个顶层目录，则创建一个新的目录来存储解压后的文件。

5. **`check_disk_space` 函数**：
   - 检查目标路径是否有足够的磁盘空间来下载和存储指定大小的文件。

6. **`get_google_drive_file_info` 函数**：
   - 获取 Google Drive 分享链接的直接下载链接和文件名。

7. **`safe_download` 函数**：
   - 安全下载文件，支持重试机制、进度条显示、解压缩和删除下载文件等功能。
   - 支持从 Google Drive 和普通 URL 下载文件。

8. **`get_github_assets` 函数**：
   - 从 GitHub 仓库的特定版本获取资产文件列表。

9. **`attempt_download_asset` 函数**：
   - 尝试从 GitHub 资产库下载指定文件，如果本地不存在则进行下载。

10. **`download` 函数**：
    - 支持多线程并发下载多个文件，并提供解压缩、删除下载文件等功能。

---

# 控制流程图

以下为 `safe_download` 函数的控制流程图，展示了其核心逻辑：

```mermaid
flowchart TD
    A[开始] --> B{URL是否为Google Drive链接?}
    B -->|是| C[获取Google Drive文件信息]
    B -->|否| D{URL是否存在本地文件?}
    C --> E[更新URL和文件名]
    E --> F{文件是否已存在?}
    D -->|是| F
    D -->|否| G{是否需要检查磁盘空间?}
    F -->|是| H[返回文件路径]
    F -->|否| I{是否需要使用curl下载?}
    I -->|是| J[使用curl下载文件]
    I -->|否| K[使用urllib或torch下载文件]
    J --> L{下载是否成功?}
    K --> L
    L -->|否| M{是否达到最大重试次数?}
    M -->|是| N[抛出连接错误]
    M -->|否| O[重试下载]
    L -->|是| P{文件大小是否大于最小字节数?}
    P -->|是| Q{是否需要解压缩?}
    P -->|否| R[删除部分下载文件]
    Q -->|是| S[解压缩文件]
    S --> T{是否需要删除下载文件?}
    T -->|是| U[删除下载文件]
    T -->|否| V[返回解压目录路径]
    Q -->|否| W[返回文件路径]
    U --> V
```

---

以下为 `unzip_file` 函数的控制流程图，展示了其核心逻辑：

```mermaid
flowchart TD
    A[开始] --> B{ZIP文件是否存在?}
    B -->|否| C[抛出BadZipFile异常]
    B -->|是| D{是否需要提取到新目录?}
    D -->|是| E[设置提取路径]
    D -->|否| F[设置默认提取路径]
    E --> G{目标目录是否为空且允许覆盖?}
    F --> G
    G -->|否| H[警告并返回路径]
    G -->|是| I[解压缩文件]
    I --> J{是否需要删除下载文件?}
    J -->|是| K[删除下载文件]
    J -->|否| L[返回解压目录路径]
    K --> L
```

---

以下为 `check_disk_space` 函数的控制流程图，展示了其核心逻辑：

```mermaid
flowchart TD
    A[开始] --> B{URL是否有效?}
    B -->|否| C[返回True]
    B -->|是| D[获取文件大小]
    D --> E{磁盘空间是否足够?}
    E -->|是| F[返回True]
    E -->|否| G{是否强制检查?}
    G -->|是| H[抛出MemoryError]
    G -->|否| I[记录警告信息]
    I --> J[返回False]
```

---

以上流程图详细描述了文件中主要逻辑的执行过程，帮助理解代码的结构和功能。